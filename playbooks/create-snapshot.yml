---
# AAP Job Template Playbook: Create VM Snapshot
# This playbook is for use in an Ansible Automation Platform Job Template
# It handles VMs with single or multiple volumes/disks automatically

- name: Create KubeVirt Snapshot via AAP
  hosts: localhost
  gather_facts: yes
  
  # Variables should be provided via AAP Job Template Extra Variables or Survey
  # Required variables:
  #   vm_name: my-vm-name
  #   vm_namespace: my-namespace
  #   kubeconfig: ~/.kube/config (or use context/host+credentials)
  #   snapshot_name: backup-20240115 (optional, auto-generated if not provided)

  tasks:
    - name: Display job information
      ansible.builtin.debug:
        msg:
          - "Creating snapshot for VM: {{ vm_name }}"
          - "Namespace: {{ vm_namespace }}"
          - "Snapshot will include ALL disks/volumes attached to the VM"
          - "This is automatic - no additional configuration needed for multi-volume VMs"

    - name: Set timestamp fact for snapshot naming
      ansible.builtin.set_fact:
        snapshot_timestamp: "{{ ansible_date_time.epoch }}"
    
    - name: Debug current snapshot_name value
      ansible.builtin.debug:
        msg:
          - "BEFORE: snapshot_name value: '{{ snapshot_name | default('UNDEFINED') }}'"
          - "BEFORE: snapshot_timestamp: {{ snapshot_timestamp }}"
    
    - name: Convert snapshot_name to string for validation
      ansible.builtin.set_fact:
        _snapshot_name_str: "{{ snapshot_name | default('') | string }}"
    
    - name: Check if snapshot name is valid (starts with aap-snapshot- followed by digits)
      ansible.builtin.set_fact:
        _snapshot_name_valid: "{{ _snapshot_name_str is regex('^aap-snapshot-\\d+$') }}"
        _has_template_pattern: "{{ 'ansible_date_time.epoch' in _snapshot_name_str }}"
    
    - name: Determine if snapshot name needs regeneration
      ansible.builtin.set_fact:
        _should_regenerate: >-
          {{
            snapshot_name is not defined or
            _snapshot_name_str | length == 0 or
            not (_snapshot_name_valid | bool) or
            (_has_template_pattern | bool)
          }}
    
    - name: Debug validation results
      ansible.builtin.debug:
        msg:
          - "snapshot_name string: '{{ _snapshot_name_str }}'"
          - "Is valid format: {{ _snapshot_name_valid }}"
          - "Has template pattern: {{ _has_template_pattern }}"
          - "Should regenerate: {{ _should_regenerate }}"
    
    - name: Always regenerate snapshot name using timestamp fact
      ansible.builtin.set_fact:
        snapshot_name: "aap-snapshot-{{ snapshot_timestamp }}"
      when: _should_regenerate | bool
    
    - name: Debug final snapshot_name value
      ansible.builtin.debug:
        msg:
          - "AFTER: snapshot_name value: '{{ snapshot_name }}'"
          - "AFTER: snapshot_name length: {{ snapshot_name | length }}"

    - name: Display snapshot name
      ansible.builtin.debug:
        msg: "Snapshot will be named: {{ snapshot_name }}"
    
    - name: Validate snapshot name is correct before calling role
      ansible.builtin.assert:
        that:
          - snapshot_name is defined
          - snapshot_name | length > 0
          - "'ansible_date_time.epoch' not in (snapshot_name | string)"
          - "(snapshot_name | string) is regex('^aap-snapshot-\\d+$')"
        fail_msg: "Snapshot name is invalid: '{{ snapshot_name }}'. It should be in format 'aap-snapshot-<timestamp>'"
        success_msg: "Snapshot name is valid: {{ snapshot_name }}"
    
    - name: Create KubeVirt snapshot
      ansible.builtin.include_role:
        name: ../roles/ocp_virt_snapshot
      # Using relative path to ensure local role is used

    - name: Display snapshot creation summary
      ansible.builtin.debug:
        msg:
          - "=== Snapshot Creation Summary ==="
          - "VM Name: {{ snapshot_info.vm_name }}"
          - "Namespace: {{ snapshot_info.vm_namespace }}"
          - "Snapshot Name: {{ snapshot_info.snapshot_name }}"
          - "Snapshot UID: {{ snapshot_info.snapshot_uid }}"
          - "Status: {{ snapshot_info.snapshot_phase }}"
          - "Disks Included: {{ snapshot_info.vm_disks_count | default('N/A') }}"
          - "Note: {{ snapshot_info.note }}"
      when: snapshot_info is defined

    - name: Verify snapshot was created
      ansible.builtin.assert:
        that:
          - snapshot_created | default(false) | bool
          - snapshot_info.status == "success"
        fail_msg: "Snapshot creation failed or verification unsuccessful"
        success_msg: "Snapshot created and verified successfully"
      when: snapshot_info is defined
