---
# Create KubeVirt VirtualMachineSnapshot

- name: Get VirtualMachine info
  kubernetes.core.k8s_info:
    api_version: kubevirt.io/v1
    kind: VirtualMachine
    name: "{{ vm_name }}"
    namespace: "{{ vm_namespace }}"
    kubeconfig: "{{ kubeconfig | default(omit) }}"
    context: "{{ context | default(omit) }}"
    host: "{{ host | default(omit) }}"
    api_key: "{{ api_key | default(omit) }}"
    username: "{{ username | default(omit) }}"
    password: "{{ password | default(omit) }}"
    validate_certs: "{{ validate_certs | default(true) }}"
  register: vm_info
  changed_when: false

- name: Fail if VM not found
  ansible.builtin.fail:
    msg: "VM '{{ vm_name }}' not found in namespace '{{ vm_namespace }}'"
  when: vm_info.resources | length == 0

- name: Create VirtualMachineSnapshot
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: snapshot.kubevirt.io/v1alpha1
      kind: VirtualMachineSnapshot
      metadata:
        name: "{{ snapshot_name }}"
        namespace: "{{ vm_namespace }}"
        labels:
          created-by: ansible
          created-date: "{{ ansible_date_time.date | replace('-', '') }}"
      spec:
        source:
          apiGroup: kubevirt.io
          kind: VirtualMachine
          name: "{{ vm_name }}"
    kubeconfig: "{{ kubeconfig | default(omit) }}"
    context: "{{ context | default(omit) }}"
    host: "{{ host | default(omit) }}"
    api_key: "{{ api_key | default(omit) }}"
    username: "{{ username | default(omit) }}"
    password: "{{ password | default(omit) }}"
    validate_certs: "{{ validate_certs | default(true) }}"
  register: snapshot_result

- name: Wait for snapshot to be ready
  kubernetes.core.k8s_info:
    api_version: snapshot.kubevirt.io/v1alpha1
    kind: VirtualMachineSnapshot
    name: "{{ snapshot_name }}"
    namespace: "{{ vm_namespace }}"
    kubeconfig: "{{ kubeconfig | default(omit) }}"
    context: "{{ context | default(omit) }}"
    host: "{{ host | default(omit) }}"
    api_key: "{{ api_key | default(omit) }}"
    username: "{{ username | default(omit) }}"
    password: "{{ password | default(omit) }}"
    validate_certs: "{{ validate_certs | default(true) }}"
  register: snapshot_status
  until: >
    snapshot_status.resources | length > 0 and
    snapshot_status.resources[0].status is defined and
    (snapshot_status.resources[0].status.readyToUse | default(false) | bool or
     snapshot_status.resources[0].status.error is defined)
  retries: 30
  delay: 5
  changed_when: false

- name: Fail if snapshot has error
  ansible.builtin.fail:
    msg: "Snapshot failed: {{ snapshot_status.resources[0].status.error.message | default('Unknown error') }}"
  when: >
    snapshot_status.resources | length > 0 and
    snapshot_status.resources[0].status.error is defined

- name: Set snapshot info fact
  ansible.builtin.set_fact:
    snapshot_created: true
    snapshot_info:
      vm_name: "{{ vm_name }}"
      vm_namespace: "{{ vm_namespace }}"
      snapshot_name: "{{ snapshot_name }}"
      snapshot_uid: "{{ snapshot_status.resources[0].metadata.uid | default('') }}"
      status: "success"
  when: >
    snapshot_status.resources | default([]) | length > 0 and
    snapshot_status.resources[0].metadata is defined
