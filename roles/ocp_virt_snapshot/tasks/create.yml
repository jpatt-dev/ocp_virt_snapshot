---
# Create KubeVirt VirtualMachineSnapshot

- name: Get VirtualMachine info
  kubernetes.core.k8s_info:
    api_version: kubevirt.io/v1
    kind: VirtualMachine
    name: "{{ vm_name }}"
    namespace: "{{ vm_namespace }}"
    kubeconfig: "{{ kubeconfig | default(omit) }}"
    context: "{{ context | default(omit) }}"
    host: "{{ host | default(omit) }}"
    api_key: "{{ api_key | default(omit) }}"
    username: "{{ username | default(omit) }}"
    password: "{{ password | default(omit) }}"
    validate_certs: "{{ validate_certs | default(true) }}"
  register: vm_info
  changed_when: false
  no_log: true
  failed_when: false

- name: Check for authentication or connection errors
  ansible.builtin.fail:
    msg: "Failed to connect to Kubernetes API. Check your credentials and API server URL. Verify the host URL is correct and credentials have proper permissions."
  when: >
    vm_info.msg is defined and
    vm_info.msg != '' and
    ('authentication' in (vm_info.msg | string | lower) or
     'unauthorized' in (vm_info.msg | string | lower) or
     'forbidden' in (vm_info.msg | string | lower) or
     'connection' in (vm_info.msg | string | lower) or
     'certificate' in (vm_info.msg | string | lower))

- name: Check for VM API availability
  ansible.builtin.fail:
    msg: "KubeVirt API is not available or VirtualMachine CRD is not installed. Verify OpenShift Virtualization is properly configured."
  when: >
    vm_info.msg is defined and
    vm_info.msg != '' and
    (('not found' in (vm_info.msg | string | lower) and 'api' in (vm_info.msg | string | lower)) or
     'does not exist' in (vm_info.msg | string | lower))

- name: Fail if VM not found
  ansible.builtin.fail:
    msg: "VM '{{ vm_name }}' not found in namespace '{{ vm_namespace }}'"
  when: >
    vm_info.resources is defined and
    vm_info.resources | length == 0

- name: Fail if VM info retrieval failed with other errors
  ansible.builtin.fail:
    msg: "Failed to retrieve VM information: {{ vm_info.msg | default('Unknown error occurred') }}"
  when: >
    (vm_info.failed | default(false) | bool or
     (vm_info.msg is defined and vm_info.msg != '')) and
    not (vm_info.resources is defined and vm_info.resources | length > 0)

- name: Create VirtualMachineSnapshot
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: snapshot.kubevirt.io/v1alpha1
      kind: VirtualMachineSnapshot
      metadata:
        name: "{{ snapshot_name }}"
        namespace: "{{ vm_namespace }}"
        labels:
          created-by: ansible
          created-date: "{{ ansible_date_time.date | replace('-', '') }}"
      spec:
        source:
          apiGroup: kubevirt.io
          kind: VirtualMachine
          name: "{{ vm_name }}"
    kubeconfig: "{{ kubeconfig | default(omit) }}"
    context: "{{ context | default(omit) }}"
    host: "{{ host | default(omit) }}"
    api_key: "{{ api_key | default(omit) }}"
    username: "{{ username | default(omit) }}"
    password: "{{ password | default(omit) }}"
    validate_certs: "{{ validate_certs | default(true) }}"
  register: snapshot_result
  no_log: true
  failed_when: false

- name: Check for snapshot API availability
  ansible.builtin.fail:
    msg: "VirtualMachineSnapshot API is not available. Verify the snapshot.kubevirt.io CRD is installed."
  when: >
    snapshot_result.msg is defined and
    snapshot_result.msg != '' and
    (('not found' in (snapshot_result.msg | string | lower) and 'api' in (snapshot_result.msg | string | lower)) or
     'does not exist' in (snapshot_result.msg | string | lower))

- name: Fail if snapshot creation failed
  ansible.builtin.fail:
    msg: "Failed to create snapshot '{{ snapshot_name }}' for VM '{{ vm_name }}' in namespace '{{ vm_namespace }}': {{ snapshot_result.msg | default('Unknown error occurred') }}"
  when: >
    snapshot_result.failed | default(false) | bool or
    (snapshot_result.msg is defined and snapshot_result.msg != '')

- name: Wait for snapshot to be ready
  kubernetes.core.k8s_info:
    api_version: snapshot.kubevirt.io/v1alpha1
    kind: VirtualMachineSnapshot
    name: "{{ snapshot_name }}"
    namespace: "{{ vm_namespace }}"
    kubeconfig: "{{ kubeconfig | default(omit) }}"
    context: "{{ context | default(omit) }}"
    host: "{{ host | default(omit) }}"
    api_key: "{{ api_key | default(omit) }}"
    username: "{{ username | default(omit) }}"
    password: "{{ password | default(omit) }}"
    validate_certs: "{{ validate_certs | default(true) }}"
  register: snapshot_status
  until: >
    snapshot_status.resources | length > 0 and
    snapshot_status.resources[0].status is defined and
    (snapshot_status.resources[0].status.readyToUse | default(false) | bool or
     snapshot_status.resources[0].status.error is defined)
  retries: 30
  delay: 5
  changed_when: false
  no_log: true

- name: Fail if snapshot has error
  ansible.builtin.fail:
    msg: "Snapshot failed: {{ snapshot_status.resources[0].status.error.message | default('Unknown error') }}"
  when: >
    snapshot_status.resources | length > 0 and
    snapshot_status.resources[0].status.error is defined

- name: Set snapshot info fact
  ansible.builtin.set_fact:
    snapshot_created: true
    snapshot_info:
      vm_name: "{{ vm_name }}"
      vm_namespace: "{{ vm_namespace }}"
      snapshot_name: "{{ snapshot_name }}"
      snapshot_uid: "{{ snapshot_status.resources[0].metadata.uid | default('') }}"
      status: "success"
  when: >
    snapshot_status.resources | default([]) | length > 0 and
    snapshot_status.resources[0].metadata is defined
