---
# OCP Virtualization Snapshot Role - Main Entry Point

- name: Debug input variables
  ansible.builtin.debug:
    msg:
      - "VM Name: '{{ vm_name | default('UNDEFINED') }}'"
      - "VM Namespace: '{{ vm_namespace | default('UNDEFINED') }}'"
      - "Snapshot Name (input): '{{ snapshot_name | default('UNDEFINED') }}'"

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - vm_name is defined
      - vm_namespace is defined
    fail_msg: "Required variables (vm_name, vm_namespace) must be defined"

- name: Set timestamp fact
  ansible.builtin.set_fact:
    snapshot_timestamp: "{{ ansible_date_time.epoch }}"

- name: Debug timestamp
  ansible.builtin.debug:
    msg:
      - "Timestamp: {{ snapshot_timestamp }}"

- name: Always generate snapshot name (override empty strings from extra_vars)
  ansible.builtin.set_fact:
    snapshot_name: "aap-snapshot-{{ snapshot_timestamp }}"
  register: snapshot_name_result
  when: >
    snapshot_name is not defined or
    (snapshot_name | default('') | string | trim | length == 0)

- name: Debug what was set in the fact
  ansible.builtin.debug:
    msg:
      - "Fact was set: {{ snapshot_name_result.ansible_facts.snapshot_name | default('NOT SET') }}"
      - "Variable value: '{{ snapshot_name | default('UNDEFINED') }}'"
  when: snapshot_name_result is defined

- name: Force snapshot name to use the generated value
  ansible.builtin.set_fact:
    snapshot_name: "{{ snapshot_name_result.ansible_facts.snapshot_name }}"
  when: >
    snapshot_name_result is defined and
    snapshot_name_result.ansible_facts.snapshot_name is defined

- name: Debug final snapshot name before include
  ansible.builtin.debug:
    msg:
      - "Final Snapshot Name: '{{ snapshot_name }}'"
      - "Snapshot Name Length: {{ snapshot_name | length }}"

- name: Include create snapshot tasks
  ansible.builtin.include_tasks: create.yml
